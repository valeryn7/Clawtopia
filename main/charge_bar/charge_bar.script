go.property("move_speed", 1.5) -- ðŸ”¥ Velocidad angular en radianes/segundo
go.property("min_angle_deg", 0) -- ðŸ”¥ Ãngulo mÃ­nimo (en grados)
go.property("max_angle_deg", 120) -- ðŸ”¥ Ãngulo mÃ¡ximo (en grados)

function init(self)
	self.moving = false
	self.angle = math.rad(self.min_angle_deg) -- ðŸ”¥ Arranca en el Ã¡ngulo mÃ­nimo
	self.min_angle = math.rad(self.min_angle_deg)
	self.max_angle = math.rad(self.max_angle_deg)
	self.direction = 1 -- ðŸ”¥ 1 = bajando, -1 = subiendo

	go.set_rotation(vmath.quat_rotation_z(self.angle)) -- ðŸ”¥ Rota al Ã¡ngulo inicial
	msg.post(msg.url(nil, "charge_bar_arc", nil), "disable")
	msg.post(msg.url(nil, "charge_arrow", nil), "disable")
end

local function calculate_strength(angle)
	-- ðŸ”¥ Suponiendo:
	-- 0Â° a 40Â° â†’ Amarillo (fuerza baja)
	-- 40Â° a 80Â° â†’ Naranja (fuerza media)
	-- 80Â° a 120Â° â†’ Rojo (fuerza alta)

	if angle >= 0 and angle < 40 then
		return 0.5 -- fuerza baja
	elseif angle >= 40 and angle < 80 then
		return 0.75 -- fuerza media
	elseif angle >= 80 and angle <= 120 then
		return 1.0 -- fuerza alta
	else
		return 0.5 -- Por defecto, por seguridad
	end
end

function update(self, dt)
	if self.moving then
		-- ðŸ”¥ Mover el Ã¡ngulo segÃºn direcciÃ³n
		self.angle = self.angle + self.direction * self.move_speed * dt

		-- ðŸ”¥ Si llega a mÃ¡ximo o mÃ­nimo, invertimos direcciÃ³n
		if self.angle >= self.max_angle then
			self.angle = self.max_angle
			self.direction = -1 -- empieza a subir
		elseif self.angle <= self.min_angle then
			self.angle = self.min_angle
			self.direction = 1 -- empieza a bajar
		end

		go.set_rotation(vmath.quat_rotation_z(-self.angle)) -- ðŸ”¥ Solo rotamos
	end
end

function on_message(self, message_id, message, sender)
	if message_id == hash("start_charge") then
		self.angle = math.rad(self.min_angle_deg)
		self.moving = false -- ðŸ” Desactivamos el movimiento automÃ¡tico
		go.set_rotation(vmath.quat_rotation_z(-self.angle))
		msg.post(msg.url(nil, "charge_bar_arc", nil), "enable")
		msg.post(msg.url(nil, "charge_arrow", nil), "enable")

	elseif message_id == hash("set_manual_angle") then
		local new_angle = math.max(self.min_angle, math.min(self.max_angle, message.angle))
		self.angle = new_angle
		go.set_rotation(vmath.quat_rotation_z(-self.angle))  -- Mostrar la flecha
		

	elseif message_id == hash("stop_charge") then
		msg.post("claw", "set_charge_angle", { angle = self.angle })
		msg.post(msg.url(nil, "charge_bar_arc", nil), "disable")
		msg.post(msg.url(nil, "charge_arrow", nil), "disable")
	end
end
